#!/usr/bin/env python3
"""trixctl - CLI for Awtrix3 smart pixel clock"""

import argparse
import configparser
import json
import os
import sys
from pathlib import Path
from awtrix3 import Awtrix3


def generate_config():
    """Generate a self-documented config file template"""
    config_content = """# trixctl Configuration File
# This file contains default settings for the trixctl command.
# CLI arguments will override these settings.
#
# For security, passwords should be set via environment variable:
# export TRIXCTL_PASSWORD="your_password"

[device]
# IP address or hostname of your Awtrix3 device
# Example: host = 192.168.1.100
host = 

# Username for device authentication (if required)
# Example: username = admin
username = 

[settings]
# Default output format (json is currently the only option)
output_format = json

# Example usage:
# ./trixctl notify "Hello World"    # Uses config file host
# ./trixctl --host 192.168.1.50 notify "Hi"  # Override with CLI arg
"""
    
    config_path = Path.home() / '.trixctl.conf'
    
    try:
        with open(config_path, 'w') as f:
            f.write(config_content)
        # Set secure permissions (owner read/write only)
        os.chmod(config_path, 0o600)
        print(f"Generated config file: {config_path}")
        print("Edit the file to set your default device settings.")
        print("Use TRIXCTL_PASSWORD environment variable for password.")
    except Exception as e:
        print(f"Error generating config: {e}", file=sys.stderr)
        sys.exit(1)


def load_config():
    """Load configuration from ~/.trixctl.conf"""
    config_path = Path.home() / '.trixctl.conf'
    config = {}
    
    if config_path.exists():
        try:
            parser = configparser.ConfigParser()
            parser.read(config_path)
            
            if 'device' in parser:
                device = parser['device']
                if device.get('host'):
                    config['host'] = device.get('host')
                if device.get('username'):
                    config['username'] = device.get('username')
                    
        except Exception as e:
            print(f"Warning: Error reading config file {config_path}: {e}", file=sys.stderr)
    
    return config


def format_stats(stats):
    """Format stats output in a user-friendly way"""
    if not stats:
        return "No stats data received"
    
    # Common stats fields to format nicely
    formatted_lines = []
    handled_keys = set()
    
    # Battery status
    if 'battery' in stats:
        battery = stats['battery']
        if isinstance(battery, (int, float)):
            formatted_lines.append(f"Battery: {battery}%")
        else:
            formatted_lines.append(f"Battery: {battery}")
        handled_keys.add('battery')
    
    # Uptime
    if 'uptime' in stats:
        uptime = stats['uptime']
        if isinstance(uptime, (int, float)):
            hours = int(uptime // 3600)
            minutes = int((uptime % 3600) // 60)
            formatted_lines.append(f"Uptime: {hours}h {minutes}m")
        else:
            formatted_lines.append(f"Uptime: {uptime}")
        handled_keys.add('uptime')
    
    # Memory/RAM
    for key in ['ram', 'memory', 'free_memory']:
        if key in stats:
            value = stats[key]
            if isinstance(value, (int, float)):
                formatted_lines.append(f"Memory: {value} KB")
            else:
                formatted_lines.append(f"Memory: {value}")
            handled_keys.add(key)
            break
    
    # Temperature  
    if 'temp' in stats:
        temp = stats['temp']
        if isinstance(temp, (int, float)):
            formatted_lines.append(f"Temperature: {temp}Â°C")
        else:
            formatted_lines.append(f"Temperature: {temp}")
        handled_keys.add('temp')
    
    # WiFi signal
    for key in ['wifi_signal', 'rssi', 'signal']:
        if key in stats:
            value = stats[key]
            formatted_lines.append(f"WiFi Signal: {value} dBm")
            handled_keys.add(key)
            break
    
    # Version/firmware
    for key in ['version', 'firmware', 'fw_version']:
        if key in stats:
            formatted_lines.append(f"Version: {stats[key]}")
            handled_keys.add(key)
            break
    
    # Handle any remaining fields
    remaining = {k: v for k, v in stats.items() if k not in handled_keys}
    
    if formatted_lines:
        output = "\n".join(formatted_lines)
        if remaining:
            output += "\n\nAdditional Data:\n" + json.dumps(remaining, indent=2)
        return output
    else:
        # No known fields, fall back to formatted JSON
        return json.dumps(stats, indent=2)


def main():
    parser = argparse.ArgumentParser(
        description='Control Awtrix3 device',
        epilog='\nThanks to @blueforcer for Awtrix3 inspiration and @claude for implementation.\n',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('--host', help='Device IP address (overrides config file)')
    parser.add_argument('--username', help='Auth username (overrides config file)')
    parser.add_argument('--password', help='Auth password (overrides config file and env var)')
    parser.add_argument('--generate-config', action='store_true', 
                       help='Generate a config file template at ~/.trixctl.conf')
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # notify command
    notify_parser = subparsers.add_parser('notify', help='Send notification')
    notify_parser.add_argument('text', help='Notification text')
    
    # stats command
    subparsers.add_parser('stats', help='Get device statistics')
    
    # power command
    power_parser = subparsers.add_parser('power', help='Power control')
    power_parser.add_argument('state', choices=['on', 'off'], help='Power state')
    
    # app command
    app_parser = subparsers.add_parser('app', help='Create custom app')
    app_parser.add_argument('name', help='App name')
    app_parser.add_argument('text', help='App text')
    
    # sound command
    sound_parser = subparsers.add_parser('sound', help='Play sound')
    sound_parser.add_argument('name', help='Sound name')
    
    args = parser.parse_args()
    
    # Handle generate-config command
    if getattr(args, 'generate_config', False):
        generate_config()
        return
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    # Load config file
    config = load_config()
    
    # Determine values with priority: CLI args > env vars > config file
    host = args.host or config.get('host')
    username = args.username or config.get('username')
    password = args.password or os.environ.get('TRIXCTL_PASSWORD')
    
    if not host:
        print("Error: No host specified. Use --host, set it in config file, or run --generate-config", file=sys.stderr)
        sys.exit(1)
    
    # Setup auth
    auth = None
    if username and password:
        auth = (username, password)
    
    # Create client
    client = Awtrix3(host, auth=auth)
    
    try:
        if args.command == 'notify':
            result = client.notify(args.text)
        elif args.command == 'stats':
            result = client.stats()
        elif args.command == 'power':
            result = client.power(args.state == 'on')
        elif args.command == 'app':
            result = client.custom_app(args.name, args.text)
        elif args.command == 'sound':
            result = client.play_sound(args.name)
        
        if result:
            if args.command == 'stats':
                print(format_stats(result))
            else:
                print(json.dumps(result, indent=2))
            
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()